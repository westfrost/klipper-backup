[gcode_macro POWER_ON]
gcode:
    {action_call_remote_method("set_device_power", device="Printer", state="on")}
    M118 Powering on printer... waiting 10 seconds for stabilization.
    UPDATE_DELAYED_GCODE ID=POWER_ON_DELAY DURATION=10

[delayed_gcode POWER_ON_DELAY]
gcode:
    M118 Power is stable. Starting print initialization.

    
[gcode_macro POWER_OFF]
gcode:
    {action_call_remote_method("set_device_power", device="Printer", state="off")}
    M118 Printer powered off.

[gcode_macro _POWER_OFF_PRINTER]
gcode:
    RUN_MACRO POWER_OFF

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode:
    {% set idle_state = printer.idle_timeout.state %}
    {% set e_temp = printer.extruder.temperature %}
    {% set b_temp = printer.heater_bed.temperature %}
    {% set e_target = printer.extruder.target %}
    {% set b_target = printer.heater_bed.target %}
    {% set msg_once = printer["gcode_macro ACTIVATE_POWER_OFF"].msg_once %}

    # Message only once
    {% if msg_once == 0 %}
        M118 Auto-shutdown active: waiting for cooldown <50Â°C.
        SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_once VALUE=1
    {% endif %}

    # Must be idle/ready
    {% if idle_state in ["Idle", "Ready"] %}

        # Cancel if user heated anything
        {% if e_target > 0 or b_target > 0 %}
            UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
            M118 Auto-shutdown cancelled: user changed temp.
            SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_once VALUE=0

        # Shut down when cool
        {% elif e_temp < 50 and b_temp < 50 %}
            UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
            SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_once VALUE=0
            RUN_MACRO POWER_OFF

        # Continue cooling
        {% else %}
            UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=5
        {% endif %}

    # Cancel if printing
    {% elif idle_state == "Printing" %}
        UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
        M118 Auto-shutdown cancelled: print started.
        SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_once VALUE=0
    {% endif %}

[gcode_macro ACTIVATE_POWER_OFF]
variable_msg_once: 0
gcode:
    SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_once VALUE=0
    UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=30
    M118 Auto-shutdown scheduled.

[gcode_macro DEACTIVATE_POWER_OFF]
gcode:
    UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
    UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
    M118 Auto-shutdown cancelled.

[delayed_gcode POWER_OFF_PRINTER_CHECK_ACT]
gcode:
    {% set idle_state = printer.idle_timeout.state %}
    {% set ps = printer.print_stats.state %}

    {% if idle_state in ["Idle", "Ready"] and ps != "paused" %}
        UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30
    {% else %}
        UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=60
    {% endif %}

[gcode_macro START_PRINT]
gcode:
    RUN_MACRO POWER_ON
    M118 Print start: power ensured ON.
    # Your normal slicer start code goes here
